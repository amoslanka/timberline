#!/usr/bin/env ruby

require 'daemons'
require 'trollop'

require 'treeline'

opts = Trollop::options do
  version "treeline #{Treeline::VERSION} (c) 2012 Tommy Morgan"
  banner <<-EOS
The treeline command-line interface allows you to easily start up Treeline queue watchers.

Usage:
       treeline [options] <filename>
where [options] are:
EOS

  opt :daemonize, "Run the queue listener as a daemon", :default => false
  opt :log_output, "log the output to <filename>.output (only applicable in conjunction with the daemonize option)", :default => false
  opt :config, "YAML config file to set up Treeline options",
        :type => String, :default => nil
end

unless opts[:config].nil?
  TREELINE_YAML = opts[:config]
end

treeline_file = ARGV[0]
treeline_spec = File.read(treeline_file)

if opts[:daemonize]
  puts "Entering daemon mode"
  Daemons.daemonize({ :app_name => treeline_file, :log_output => opts[:log_output] })
end

puts "Listening..."
Treeline.class_eval(treeline_spec)
